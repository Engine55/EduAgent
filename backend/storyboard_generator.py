#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
åˆ†é•œç”Ÿæˆå™¨ï¼šåŸºäºRPGæ¡†æ¶å’Œå…³å¡æ•°æ®ç”Ÿæˆè¯¦ç»†åˆ†é•œè„šæœ¬
è¾“å…¥ï¼šRPGæ•…äº‹æ¡†æ¶ + å•ä¸ªå…³å¡æ•°æ®
è¾“å‡ºï¼šåˆ†é•œåŸºç¡€ä¿¡æ¯ã€äººç‰©å¯¹è¯ã€å‰§æœ¬ã€å›¾ç‰‡æç¤ºè¯
"""

import json
import os
import asyncio
import concurrent.futures
from datetime import datetime
from database_client import db_client
from dotenv import load_dotenv
from openai import OpenAI

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# åˆ†é•œç”Ÿæˆpromptæ¨¡æ¿
STORYBOARD_PROMPT = """ä½ æ˜¯ä¸€å"å‰§æƒ…é©±åŠ¨æ•™è‚²æ¸¸æˆè®¾è®¡å¸ˆ"ã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ›é€ çœŸæ­£çš„æ•…äº‹å†’é™©ï¼Œå…¶ä¸­{subject}çŸ¥è¯†æ˜¯è§£å†³å›°å¢ƒã€æ¨è¿›å‰§æƒ…çš„æ ¸å¿ƒå·¥å…·ï¼Œè€Œä¸æ˜¯é™„åŠ çš„å­¦ä¹ ä»»åŠ¡ã€‚

ã€æ ¸å¿ƒè®¾è®¡ç†å¿µã€‘
- æ•°å­¦çŸ¥è¯†å¿…é¡»æ˜¯è§£å†³å‰§æƒ…å›°å¢ƒçš„å”¯ä¸€é€”å¾„
- è§’è‰²æœ‰çœŸå®çš„åŠ¨æœºå’Œç›®æ ‡ï¼Œé‡åˆ°çœŸå®çš„å›°éš¾
- å­¦ä¹ è¿‡ç¨‹ä¼ªè£…æˆ"å‘ç°ä¸–ç•Œè§„å¾‹"å’Œ"è§£è°œæ¢ç´¢"
- é¿å…"è€å¸ˆå‡ºé¢˜"æ¨¡å¼ï¼Œé‡‡ç”¨"ä¼™ä¼´æ¢ç´¢"æ¨¡å¼

ã€RPGæ¡†æ¶ã€‘
- æ ‡é¢˜ï¼š{title}
- ä¸–ç•Œè§‚ï¼š{worldview} 
- ä¸»çº¿å‰§æƒ…ï¼š{main_plot}
- ç©å®¶è§’è‰²ï¼š{player_character}
- NPCè§’è‰²ï¼š{npc_character}

ã€å…³å¡æ•°æ®ã€‘
- å…³å¡åç§°ï¼š{stage_name}
- åœºæ™¯åç§°ï¼š{scene_name}  
- å…³å¡ç¼–å·ï¼š{stage_id}
- æ•™å­¦ç›®æ ‡ï¼š{teaching_goal}
- æ•…äº‹æƒ…å¢ƒï¼š{story_context}
- çŸ¥è¯†è®²è§£ï¼š{knowledge_explanation}
- ä¸‹ä¸€å…³é€‰é¡¹ï¼š{next_options}
- æ˜¯å¦ç»“æŸèŠ‚ç‚¹ï¼š{is_final}

ã€å‰§æƒ…é©±åŠ¨è®¾è®¡è¦æ±‚ã€‘

1) **åˆ†é•œåŸºç¡€ä¿¡æ¯**ï¼š
   - åˆ†é•œç¼–å·ï¼šæŒ‰"scene_[å…³å¡ç¼–å·]"æ ¼å¼
   - åœºæ™¯ç±»å‹ï¼šå¦‚"å›°å¢ƒå‘ç°åœºæ™¯"ã€"æ¢ç´¢è§£è°œåœºæ™¯"ã€"çªç ´åœºæ™¯"ç­‰
   - æ—¶é•¿ä¼°è®¡ï¼šé¢„ä¼°è¯¥åˆ†é•œçš„æ¸¸æˆæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰  
   - å…³é”®äº‹ä»¶ï¼šæè¿°è§’è‰²é¢ä¸´çš„çœŸå®å›°å¢ƒå’Œ{subject}çŸ¥è¯†å¦‚ä½•æˆä¸ºè§£å†³æ–¹æ¡ˆ

2) **äººç‰©æ¡£æ¡ˆ**ï¼š
   - ä¸»è§’ä¿¡æ¯ï¼šè§’è‰²åã€å¤–è²Œã€æ€§æ ¼ã€å½“å‰å›°å¢ƒå’Œç›®æ ‡
   - NPCä¿¡æ¯ï¼šè§’è‰²åã€å¤–è²Œã€æ€§æ ¼ã€ä¸ä¸»è§’çš„å…³ç³»ã€æŒæ¡çš„å…³é”®ä¿¡æ¯
   - è§’è‰²å¿…é¡»æœ‰çœŸå®çš„åŠ¨æœºï¼Œä¸æ˜¯ä¸ºäº†å­¦ä¹ è€Œå­˜åœ¨
   - å¤–è²Œå’Œæ€§æ ¼è¦é€‚åˆ{grade}å¹´çº§å­¦ç”Ÿç†è§£å’Œå–œçˆ±

3) **å‰§æƒ…é©±åŠ¨å¯¹è¯è®¾è®¡**ï¼š
   - **å›°å¢ƒå‘ˆç°é˜¶æ®µ**ï¼šè§’è‰²é‡åˆ°çœŸå®é—®é¢˜ï¼Œæ„Ÿåˆ°å›°æƒ‘å’ŒæŒ«è´¥
   - **æ¢ç´¢å‘ç°é˜¶æ®µ**ï¼šè§’è‰²å¼€å§‹æ¢ç´¢ï¼Œå‘ç°é—®é¢˜å¯èƒ½æœ‰è§„å¾‹å¯å¾ª
   - **çŸ¥è¯†èåˆé˜¶æ®µ**ï¼š{subject}çŸ¥è¯†è‡ªç„¶æµ®ç°ä¸ºè§£å†³æ–¹æ¡ˆï¼Œä¸æ˜¯è¢«"æ•™æˆ"çš„
   - **äº’åŠ¨è§£è°œç¯èŠ‚**ï¼šç©å®¶è¿ç”¨çŸ¥è¯†è§£å†³å›°å¢ƒï¼Œæ¨è¿›å‰§æƒ…
     * ä¼ªè£…æˆä¸–ç•Œè§„å¾‹ï¼šè®©æ•°å­¦çœ‹èµ·æ¥æ˜¯è¿™ä¸ªä¸–ç•Œçš„è‡ªç„¶æ³•åˆ™
     * æ¢ç´¢å¼å‘ç°ï¼šç©å®¶é€šè¿‡å°è¯•å’Œè§‚å¯Ÿå‘ç°è§„å¾‹
     * æˆå°±æ„Ÿè®¾è®¡ï¼šè§£å†³é—®é¢˜åè·å¾—å‰§æƒ…å¥–åŠ±ï¼Œä¸åªæ˜¯"ç­”å¯¹äº†"
   - **æƒ…æ„Ÿå˜åŒ–è½¨è¿¹**ï¼šå›°æƒ‘ â†’ å¥½å¥‡ â†’ æç„¶å¤§æ‚Ÿ â†’ å…´å¥‹æˆå°±
   - å¯¹è¯è¦ä½“ç°è§’è‰²é—´çš„çœŸå®æƒ…æ„Ÿäº’åŠ¨ï¼Œä¸æ˜¯é—®ç­”å…³ç³»

4) **æ²‰æµ¸å¼å‰§æœ¬è®¾è®¡**ï¼š
   - å›°å¢ƒè®¾ç½®ï¼šè¯¦ç»†æè¿°è§’è‰²é¢ä¸´çš„å…·ä½“å›°å¢ƒï¼Œè¦è®©ç©å®¶æ„ŸåŒèº«å—
   - æ¢ç´¢è¿‡ç¨‹ï¼šè§’è‰²å¦‚ä½•ä¸€æ­¥æ­¥å‘ç°é—®é¢˜èƒŒåçš„è§„å¾‹ï¼Œä½“ç°æ€è€ƒè¿‡ç¨‹
   - çŸ¥è¯†è‡ªç„¶å‘ˆç°ï¼š{subject}çŸ¥è¯†å¦‚ä½•ä½œä¸º"ä¸–ç•Œæ³•åˆ™"è‡ªç„¶å‡ºç°ï¼Œä¸æ˜¾çªå…€
   - è§£å†³æ–¹æ¡ˆå®æ–½ï¼šç©å®¶è¿ç”¨çŸ¥è¯†è§£å†³é—®é¢˜çš„å…·ä½“è¿‡ç¨‹å’Œæ­¥éª¤
   - å‰§æƒ…å¥–åŠ±ï¼šæˆåŠŸåè·å¾—çš„æ•…äº‹è¿›å±•ï¼Œè®©ç©å®¶æœ‰çœŸå®çš„æˆå°±æ„Ÿ

5) **æ²‰æµ¸å¼äº’åŠ¨è®¾è®¡**ï¼š  
   - **ä¸–ç•Œè§„å¾‹æ¢ç´¢**ï¼šå°†{subject}çŸ¥è¯†åŒ…è£…æˆè¿™ä¸ªä¸–ç•Œçš„è‡ªç„¶æ³•åˆ™
   - **å›°å¢ƒè§£å†³æœºåˆ¶**ï¼šè®¾è®¡å¤šç§äº’åŠ¨æ–¹å¼è®©ç©å®¶"ç ´è§£"å›°å¢ƒï¼š
     * å¤è€æœºå…³ï¼šéœ€è¦æ•°å­¦è§„å¾‹æ‰èƒ½å¼€å¯
     * è‡ªç„¶ç°è±¡ï¼šéµå¾ªæ•°å­¦è§„å¾‹çš„é­”æ³•æˆ–ç§‘å­¦ç°è±¡  
     * ç¤¾äº¤è°œé¢˜ï¼šéœ€è¦è®¡ç®—æ‰èƒ½åŒ–è§£çš„äººé™…å›°å¢ƒ
     * èµ„æºç®¡ç†ï¼šéœ€è¦æ•°å­¦ä¼˜åŒ–çš„ç­–ç•¥å†³ç­–
   - **åé¦ˆè®¾è®¡**ï¼šæˆåŠŸæ—¶è·å¾—å‰§æƒ…æ¨è¿›ï¼Œå¤±è´¥æ—¶æä¾›æ–°çš„æ¢ç´¢çº¿ç´¢
   - **æ²‰æµ¸æ„Ÿç»´æŠ¤**ï¼šå§‹ç»ˆä¿æŒè§’è‰²åŠ¨æœºå’Œä¸–ç•Œè§‚çš„ä¸€è‡´æ€§

6) **è§†è§‰ä¸–ç•Œæ„å»º**ï¼š
   - è§†è§‰é£æ ¼ï¼šä½“ç°å›°å¢ƒç´§å¼ æ„Ÿå’Œè§£å†³åæˆå°±æ„Ÿçš„ç”»é¢é£æ ¼
   - åœºæ™¯æè¿°ï¼šå±•ç°è§’è‰²å›°å¢ƒå’Œ{subject}çŸ¥è¯†èå…¥ä¸–ç•Œçš„è§†è§‰å…ƒç´ 
   - è§’è‰²çŠ¶æ€ï¼šä½“ç°è§’è‰²å½“å‰çš„æƒ…æ„ŸçŠ¶æ€å’ŒåŠ¨æœº
   - ä¸–ç•Œç»†èŠ‚ï¼šæš—ç¤º{subject}çŸ¥è¯†åœ¨è¿™ä¸ªä¸–ç•Œä¸­çš„é‡è¦åœ°ä½
   - æŠ€æœ¯å‚æ•°ï¼šé«˜åˆ†è¾¨ç‡åƒç´ è‰ºæœ¯é£æ ¼ï¼Œé€‚åˆæ•™è‚²æ¸¸æˆ

ã€å‰§æƒ…é©±åŠ¨æ ¸å¿ƒåŸåˆ™ã€‘

1) **å›°å¢ƒçœŸå®æ€§åŸåˆ™**ï¼š
   - è§’è‰²é¢ä¸´çš„å›°å¢ƒå¿…é¡»æ˜¯ä»–ä»¬ä¸–ç•Œä¸­çš„çœŸå®é—®é¢˜
   - {subject}çŸ¥è¯†æ˜¯è§£å†³å›°å¢ƒçš„å”¯ä¸€åˆç†è·¯å¾„
   - å›°å¢ƒéš¾åº¦é€‚åˆ{grade}å¹´çº§å­¦ç”Ÿçš„è®¤çŸ¥æŒ‘æˆ˜
   - è§£å†³å›°å¢ƒåå¿…é¡»è·å¾—æœ‰æ„ä¹‰çš„æ•…äº‹è¿›å±•

2) **çŸ¥è¯†è‡ªç„¶èåˆåŸåˆ™**ï¼š
   - {subject}çŸ¥è¯†çœ‹èµ·æ¥æ˜¯è¿™ä¸ªä¸–ç•Œçš„è‡ªç„¶æ³•åˆ™
   - é¿å…"æ•™å­¦æ—¶åˆ»"ï¼Œé‡‡ç”¨"å‘ç°æ—¶åˆ»"
   - çŸ¥è¯†ç‚¹é€šè¿‡è§’è‰²æ¢ç´¢å’Œå°è¯•è‡ªç„¶å‘ˆç°
   - å­¦ä¹ è¿‡ç¨‹ä¼ªè£…æˆè§£è°œå’Œå†’é™©

3) **æƒ…æ„Ÿé©±åŠ¨åŸåˆ™**ï¼š
   - è§’è‰²æœ‰çœŸå®çš„æƒ…æ„ŸåŠ¨æœºå’Œç›®æ ‡è¿½æ±‚
   - å›°å¢ƒå¸¦æ¥çœŸå®çš„æŒ«è´¥æ„Ÿå’Œç´§è¿«æ„Ÿ
   - è§£å†³é—®é¢˜å¸¦æ¥çœŸå®çš„æˆå°±æ„Ÿå’Œæ•…äº‹æ¨è¿›
   - NPCä¸ä¸»è§’æ˜¯æ¢ç´¢ä¼™ä¼´ï¼Œä¸æ˜¯å¸ˆç”Ÿå…³ç³»

4) **ä¸–ç•Œè§‚ä¸€è‡´æ€§åŸåˆ™**ï¼š
   - æ¯ä¸ªå…³å¡éƒ½æ¨è¿›ä¸»çº¿å‰§æƒ…
   - {subject}çŸ¥è¯†åœ¨ä¸–ç•Œè§‚ä¸­æœ‰åˆç†çš„å­˜åœ¨æ„ä¹‰
   - è§’è‰²è¡Œä¸ºç¬¦åˆå…¶åŠ¨æœºå’Œä¸–ç•Œè®¾å®š
   - ä¿æŒæ²‰æµ¸æ„Ÿï¼Œé¿å…ç ´åç¬¬å››å µå¢™

ã€è¾“å‡ºæ ¼å¼ã€‘ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONç»“æ„ï¼š

{{
  "åˆ†é•œåŸºç¡€ä¿¡æ¯": {{
    "åˆ†é•œç¼–å·": "scene_{stage_id}",
    "åœºæ™¯ç±»å‹": "...",
    "æ—¶é•¿ä¼°è®¡": "...åˆ†é’Ÿ",
    "å…³é”®äº‹ä»¶": "..."
  }},
  "äººç‰©æ¡£æ¡ˆ": {{
    "ä¸»è§’": {{
      "è§’è‰²å": "...",
      "å¤–è²Œ": "...",
      "æ€§æ ¼": "...",
      "ç‰¹æ®Šèƒ½åŠ›": "..."
    }},
    "NPC": {{
      "è§’è‰²å": "...",
      "å¤–è²Œ": "...",
      "æ€§æ ¼": "...",
      "ä½œç”¨": "..."
    }}
  }},
  "äººç‰©å¯¹è¯": {{
    "å¼€åœºå¯¹è¯": [
      {{
        "è§’è‰²": "NPC",
        "å†…å®¹": "..."
      }},
      {{
        "è§’è‰²": "ç©å®¶",
        "å†…å®¹": "..."
      }}
    ],
    "å­¦ä¹ å¯¹è¯": [
      {{
        "è§’è‰²": "NPC", 
        "å†…å®¹": "..."
      }}
    ],
    "å‰§æƒ…è§£è°œç¯èŠ‚": {{
      "å›°å¢ƒæè¿°": "è§’è‰²é¢ä¸´çš„å…·ä½“å›°å¢ƒå’ŒæŒ‘æˆ˜",
      "æ¢ç´¢è¿‡ç¨‹": "è§’è‰²å¦‚ä½•é€æ­¥å‘ç°è§£å†³æ–¹æ¡ˆçš„çº¿ç´¢",
      "ä¸–ç•Œè§„å¾‹": "è¿™ä¸ªä¸–ç•Œä¸­ä¸{subject}çŸ¥è¯†ç›¸å…³çš„è‡ªç„¶æ³•åˆ™",
      "è§£è°œæœºåˆ¶": {{
        "æœºåˆ¶ç±»å‹": "å¤è€æœºå…³|è‡ªç„¶ç°è±¡|ç¤¾äº¤è°œé¢˜|èµ„æºç®¡ç†",
        "æ“ä½œè¯´æ˜": "ç©å®¶éœ€è¦è¿›è¡Œçš„å…·ä½“æ“ä½œ",
        "çŸ¥è¯†åº”ç”¨": "{subject}çŸ¥è¯†å¦‚ä½•åœ¨æ“ä½œä¸­è‡ªç„¶ä½“ç°",
        "å›°å¢ƒçº¿ç´¢": "å¸®åŠ©ç©å®¶æ€è€ƒçš„ç¯å¢ƒçº¿ç´¢å’Œè§’è‰²æç¤º"
      }},
      "æˆåŠŸå¥–åŠ±": {{
        "å‰§æƒ…è¿›å±•": "è§£å†³å›°å¢ƒåè·å¾—çš„æ•…äº‹å‘å±•",
        "è§’è‰²æˆé•¿": "ä¸»è§’åœ¨æƒ…æ„Ÿå’Œèƒ½åŠ›ä¸Šçš„æˆé•¿",
        "ä¸–ç•Œå˜åŒ–": "è§£å†³é—®é¢˜å¯¹æ¸¸æˆä¸–ç•Œäº§ç”Ÿçš„ç§¯æå½±å“"
      }},
      "å¼•å¯¼æœºåˆ¶": {{
        "ç¬¬ä¸€æ¬¡å¤±è´¥": "NPCæä¾›çš„ç¬¬ä¸€å±‚æç¤ºå’Œé¼“åŠ±",
        "ç¬¬äºŒæ¬¡å¤±è´¥": "æ›´ç›´æ¥çš„çº¿ç´¢å’Œæ€è·¯å¼•å¯¼",
        "æŒç»­å¼•å¯¼": "é€æ­¥å¼•å¯¼ç›´åˆ°å­¦ç”Ÿæ‰¾åˆ°æ­£ç¡®ç­”æ¡ˆçš„æœºåˆ¶",
        "æœ€ç»ˆå¸®åŠ©": "ç¡®ä¿å­¦ç”Ÿæœ€ç»ˆæˆåŠŸçš„å…œåº•æ”¯æŒ"
      }}
    }},
    "åœºæ™¯è½¬æ¢": {{
      "node_id_1": "é€‰é¡¹1æè¿°...",
      "node_id_2": "é€‰é¡¹2æè¿°..."
    }}
  }},
  "å‰§æœ¬": {{
    "æ—ç™½": "æ•…äº‹æƒ…å¢ƒçš„èƒŒæ™¯ä»‹ç»ï¼Œè¯¦ç»†æè¿°å½“å‰åœºæ™¯çš„ç¯å¢ƒã€æ°›å›´ã€ä»¥åŠç©å®¶è§’è‰²æ‰€å¤„çš„çŠ¶å†µã€‚è¦ç”ŸåŠ¨å…·ä½“ï¼Œè®©è¯»è€…èƒ½å¤Ÿæƒ³è±¡å‡ºå®Œæ•´çš„åœºæ™¯ç”»é¢ã€‚",
    "æƒ…èŠ‚æè¿°": "å°†æ•…äº‹æƒ…å¢ƒå†™å¾—æ›´åŠ å®Œæ•´è¯¦ç»†ï¼Œä¸ä»…åŒ…å«åŸºæœ¬çš„æ•…äº‹èƒŒæ™¯ï¼Œè¿˜è¦æè¿°è§’è‰²çš„å¿ƒç†çŠ¶æ€ã€ç¯å¢ƒçš„ç»†èŠ‚å˜åŒ–ã€ä»¥åŠæ¨åŠ¨å‰§æƒ…å‘å±•çš„å…³é”®äº‹ä»¶ã€‚è¦æœ‰èµ·æ‰¿è½¬åˆçš„å®Œæ•´ç»“æ„ã€‚",
    "äº’åŠ¨è®¾è®¡": "ç»“åˆæ•…äº‹æƒ…æ™¯å’ŒRPGæ¡†æ¶ï¼Œæ ¹æ®ç”¨æˆ·é€‰æ‹©/å¸Œæœ›çš„äº’åŠ¨æ–¹å¼æ¥è®¾è®¡å…·ä½“çš„äº’åŠ¨ç¯èŠ‚ã€‚åŒ…æ‹¬ï¼šç©å®¶å¦‚ä½•å‘ç°é¢˜ç›®ã€ä¸NPCçš„äº’åŠ¨è¿‡ç¨‹ã€è§£é¢˜çš„å…·ä½“æ­¥éª¤ã€ä¸åŒäº’åŠ¨æ–¹å¼çš„å®ç°æ–¹æ³•ï¼ˆå¦‚é€‰æ‹©é¢˜ç‚¹å‡»ã€å¡«ç©ºé¢˜è¾“å…¥ã€æ“ä½œé¢˜æ‹–æ‹½ç­‰ï¼‰ã€ä»¥åŠæˆåŠŸ/å¤±è´¥åçš„åé¦ˆæœºåˆ¶ã€‚è¦è®©å­¦ä¹ è¿‡ç¨‹è‡ªç„¶èå…¥æ¸¸æˆæƒ…å¢ƒä¸­ï¼Œç¡®ä¿äº’åŠ¨æ–¹å¼ç¬¦åˆæ•™å­¦ç›®æ ‡å’Œå­¦ç”Ÿå¹´é¾„ç‰¹ç‚¹ã€‚"
  }},
  "å›¾ç‰‡æç¤ºè¯": {{
    "è§†è§‰é£æ ¼": "ä¸åœºæ™¯åç§°ã€RPGæ¡†æ¶ä»¥åŠæ•™è‚²ç›®æ ‡é…å¥—çš„è§†è§‰é£æ ¼æè¿°...",
    "åœºæ™¯æè¿°": "ä¸åœºæ™¯åç§°ã€RPGæ¡†æ¶ä»¥åŠæ•™è‚²ç›®æ ‡é…å¥—çš„æ•…äº‹æƒ…æ™¯ç”Ÿæˆçš„åœºæ™¯æè¿°...",
    "è§’è‰²æè¿°": "NPCè§’è‰²å’Œç©å®¶è§’è‰²çš„è¯¦ç»†å¤–è§‚å’Œç‰¹å¾æè¿°...",
    "æ„å›¾è¦æ±‚": "æ ¹æ®å…³å¡æ‰€å¤„çš„æ•…äº‹é˜¶æ®µèµ·åˆ°çš„ä½œç”¨æ€§ä»¥åŠç¬¦åˆåœºæ™¯å†…å®¹ã€RPGæ¡†æ¶çš„è§†è§‰å…ƒç´ æ„å›¾è¦æ±‚...",
    "æŠ€æœ¯å‚æ•°": "é«˜åˆ†è¾¨ç‡ï¼Œé€‚åˆç§»åŠ¨ç«¯å‘ˆç°ï¼Œä»¥åŠå…¶ä»–æŠ€æœ¯è¦æ±‚..."
  }}
}}

ã€å‰§æƒ…é©±åŠ¨å¡«å†™è¦æ±‚ã€‘
- **äººç‰©å¯¹è¯**ï¼šä½“ç°"å›°æƒ‘â†’æ¢ç´¢â†’å‘ç°â†’æˆå°±"çš„æƒ…æ„Ÿè½¨è¿¹ï¼Œé¿å…ç›´æ¥æ•™å­¦å¼é—®ç­”
- **äº’åŠ¨é—®ç­”ç¯èŠ‚**ï¼šè®¾è®¡æˆè§£å†³å‰§æƒ…å›°å¢ƒçš„å…³é”®ç¯èŠ‚ï¼Œ{subject}çŸ¥è¯†æ˜¯çªç ´å›°å¢ƒçš„é’¥åŒ™
  * NPCå­—æ®µï¼šæè¿°å›°å¢ƒè€Œä¸æ˜¯å‡ºé¢˜
  * ä¸»è§’é€‰é¡¹ï¼šä½“ç°ä¸åŒçš„è§£å†³æ€è·¯ï¼Œæ­£ç¡®ç­”æ¡ˆæ¨è¿›å‰§æƒ…
  * åé¦ˆæœºåˆ¶ï¼šæˆåŠŸè·å¾—å‰§æƒ…å¥–åŠ±ï¼Œå¤±è´¥è·å¾—æ–°çº¿ç´¢ç»§ç»­å¼•å¯¼
- **å‰§æœ¬ä¸‰è¦ç´ **ï¼š
  * æ—ç™½ï¼šè¥é€ å›°å¢ƒæ°›å›´å’Œç´§å¼ æ„Ÿ
  * æƒ…èŠ‚æè¿°ï¼šå±•ç°è§’è‰²çœŸå®åŠ¨æœºå’Œæƒ…æ„Ÿå˜åŒ–
  * äº’åŠ¨è®¾è®¡ï¼šå°†{subject}çŸ¥è¯†åŒ…è£…æˆä¸–ç•Œè§„å¾‹ï¼Œé¿å…"æ•™å­¦æ„Ÿ"
- **å›¾ç‰‡æç¤ºè¯**ï¼šä½“ç°è§’è‰²å›°å¢ƒçŠ¶æ€å’Œè§£å†³åçš„æˆå°±æ„Ÿ
- **åœºæ™¯è½¬æ¢**ï¼šåŸºäºè§£å†³å›°å¢ƒåçš„å‰§æƒ…å‘å±•ï¼Œæ ¼å¼ï¼š"ç›®æ ‡èŠ‚ç‚¹ID: é€‰é¡¹æè¿°"
- ç»“æŸèŠ‚ç‚¹å¯çœç•¥åœºæ™¯è½¬æ¢å­—æ®µ
- JSONæ ¼å¼å¿…é¡»æ­£ç¡®ï¼Œæ‰€æœ‰å­—æ®µå¿…é¡»è¯¦å®å¡«å†™

ã€æ ¸å¿ƒç›®æ ‡ã€‘
è®©å­¦ç”Ÿæ„Ÿè§‰åœ¨"å†’é™©è§£è°œæ¨è¿›å‰§æƒ…"ï¼Œè€Œä¸æ˜¯"è¢«è¦æ±‚å­¦ä¹ åšé¢˜"ã€‚{subject}çŸ¥è¯†æ˜¯æ¢ç´¢å·¥å…·ï¼Œå›°å¢ƒæ˜¯å­¦ä¹ åŠ¨æœºï¼ŒæˆåŠŸæ˜¯çœŸå®å¥–åŠ±ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§å‰§æƒ…é©±åŠ¨ç†å¿µç”Ÿæˆåˆ†é•œè„šæœ¬ã€‚"""


def generate_storyboard(rpg_framework, stage_data, subject="", grade=""):
    """ç”Ÿæˆå•ä¸ªå…³å¡çš„åˆ†é•œè„šæœ¬"""
    try:
        # æ ¼å¼åŒ–prompt
        formatted_prompt = STORYBOARD_PROMPT.format(
            title=rpg_framework.get('æ ‡é¢˜', ''),
            worldview=rpg_framework.get('ä¸–ç•Œè§‚', ''),
            main_plot=rpg_framework.get('ä¸»çº¿å‰§æƒ…', ''),
            player_character=rpg_framework.get('ä¸»è¦è§’è‰²', {}).get('ç©å®¶è§’è‰²', ''),
            npc_character=rpg_framework.get('ä¸»è¦è§’è‰²', {}).get('NPC', ''),
            
            stage_name=stage_data.get('å…³å¡åç§°', ''),
            scene_name=stage_data.get('åœºæ™¯åç§°', ''),
            stage_id=stage_data.get('å…³å¡ç¼–å·', ''),
            teaching_goal=stage_data.get('æ•™å­¦ç›®æ ‡', ''),
            story_context=stage_data.get('æ•…äº‹æƒ…å¢ƒ', ''),
            knowledge_explanation=stage_data.get('çŸ¥è¯†è®²è§£', ''),
            next_options=json.dumps(stage_data.get('ä¸‹ä¸€å…³é€‰é¡¹', {}), ensure_ascii=False),
            is_final=stage_data.get('æ˜¯å¦ç»“æŸèŠ‚ç‚¹', False),
            
            subject=subject,
            grade=grade
        )
        
        print(f"ğŸ¬ æ­£åœ¨ç”Ÿæˆå…³å¡ {stage_data.get('å…³å¡åç§°', '')} çš„åˆ†é•œè„šæœ¬...")
        
        # è°ƒç”¨OpenAI API
        client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
        response = client.chat.completions.create(
            model="gpt-4-turbo-preview",
            messages=[
                {
                    "role": "system",
                    "content": "ä½ æ˜¯ä¸“ä¸šçš„æ•™è‚²æ¸¸æˆåˆ†é•œè®¾è®¡å¸ˆï¼Œæ“…é•¿åˆ›ä½œç”ŸåŠ¨æœ‰è¶£çš„æ•™å­¦æ¸¸æˆå‰§æœ¬ã€‚"
                },
                {
                    "role": "user",
                    "content": formatted_prompt
                }
            ],
            temperature=0.8,
            max_tokens=3000
        )
        
        return response.choices[0].message.content
        
    except Exception as e:
        print(f"âŒ åˆ†é•œç”Ÿæˆå¤±è´¥: {e}")
        return None


def clean_and_parse_json(raw_output):
    """æ¸…ç†å¹¶è§£æAIè¾“å‡ºçš„JSON"""
    try:
        # æ¸…ç†markdownä»£ç å—æ ‡è®°
        cleaned = raw_output.strip()
        if cleaned.startswith("```json"):
            cleaned = cleaned[7:]
        if cleaned.startswith("```"):
            cleaned = cleaned[3:]
        if cleaned.endswith("```"):
            cleaned = cleaned[:-3]
        
        cleaned = cleaned.strip()
        return json.loads(cleaned)
        
    except json.JSONDecodeError as e:
        print(f"âŒ JSONè§£æå¤±è´¥: {e}")
        print(f"åŸå§‹è¾“å‡ºå‰200å­—ç¬¦: {raw_output[:200]}...")
        return None




def get_story_data(redis_client, story_id=None):
    """ä»Redisè·å–æ•…äº‹æ•°æ®"""
    try:
        if not story_id:
            # è·å–æœ€æ–°çš„æ•…äº‹
            index_key = "eduagent:story_index"
            story_list_data = redis_client.get(index_key)
            if story_list_data:
                story_list = json.loads(story_list_data)
                if story_list:
                    story_id = story_list[-1]["story_id"]
                    print(f"ğŸ“– ä½¿ç”¨æœ€æ–°æ•…äº‹: {story_id}")
                else:
                    print("âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ•…äº‹æ•°æ®")
                    return None
            else:
                print("âŒ æ•…äº‹ç´¢å¼•ä¸å­˜åœ¨")
                return None
        
        # è·å–æ•…äº‹å®Œæ•´æ•°æ®
        main_key = f"eduagent:stories:{story_id}"
        story_data = redis_client.get(main_key)
        if story_data:
            return json.loads(story_data)
        else:
            print(f"âŒ æœªæ‰¾åˆ°æ•…äº‹æ•°æ®: {story_id}")
            return None
            
    except Exception as e:
        print(f"âŒ è·å–æ•…äº‹æ•°æ®å¤±è´¥: {e}")
        return None


def get_stage1_data(redis_client, requirement_id=None):
    """è·å–ç¬¬ä¸€é˜¶æ®µæ•°æ®ï¼ˆåŒ…å«collected_infoå­—æ®µï¼‰"""
    try:
        if requirement_id:
            key = f"eduagent:requirements:{requirement_id}"
        else:
            # è·å–æœ€æ–°çš„
            keys = redis_client.keys("eduagent:requirements:requirement_*")
            if not keys:
                print("âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç¬¬ä¸€é˜¶æ®µæ•°æ®")
                return None
            key = keys[0]
        
        data = redis_client.get(key)
        if not data:
            print(f"âŒ æœªæ‰¾åˆ°ç¬¬ä¸€é˜¶æ®µæ•°æ®")
            return None
        
        return json.loads(data)
    except Exception as e:
        print(f"âŒ è·å–ç¬¬ä¸€é˜¶æ®µæ•°æ®å¤±è´¥: {e}")
        return None


def generate_all_storyboards(story_id=None):
    """ä¸ºæŒ‡å®šæ•…äº‹ç”Ÿæˆæ‰€æœ‰å…³å¡çš„åˆ†é•œ"""
    # ä½¿ç”¨æ•°æ®åº“å®¢æˆ·ç«¯
    if not db_client:
        print("âŒ æ•°æ®åº“è¿æ¥å¤±è´¥")
        return
    
    # è·å–æ•…äº‹æ•°æ®
    story_data = get_story_data(story_id)
    if not story_data:
        return
    
    # è·å–ç¬¬ä¸€é˜¶æ®µæ•°æ®ï¼ˆåŒ…å«collected_infoï¼‰
    stage1_data = get_stage1_data()
    if not stage1_data:
        print("âš ï¸ æœªæ‰¾åˆ°ç¬¬ä¸€é˜¶æ®µæ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼")
        collected_info = {}
    else:
        collected_info = stage1_data.get('collected_info', {})
    
    rpg_framework = story_data.get("rpg_framework", {})
    stages_data = story_data.get("stages_data", [])
    
    print(f"ğŸ® æ•…äº‹æ ‡é¢˜: {rpg_framework.get('æ ‡é¢˜', 'æœªçŸ¥')}")
    print(f"ğŸ“š æ€»å…³å¡æ•°: {len(stages_data)}")
    print(f"ğŸ“ å­¦ç§‘å¹´çº§: {collected_info.get('subject', 'æœªçŸ¥')} - {collected_info.get('grade', 'æœªçŸ¥')}")
    
    # ç”Ÿæˆæ‰€æœ‰åˆ†é•œ
    all_storyboards = []
    for i, stage_data in enumerate(stages_data):
        print(f"\nğŸ¬ ç”Ÿæˆç¬¬ {i+1}/{len(stages_data)} ä¸ªå…³å¡çš„åˆ†é•œ...")
        print(f"å…³å¡åç§°: {stage_data.get('å…³å¡åç§°', f'å…³å¡{i+1}')}")
        
        # ç”Ÿæˆåˆ†é•œï¼Œä½¿ç”¨collected_infoä¸­çš„å­—æ®µ
        storyboard_raw = generate_storyboard(
            rpg_framework, 
            stage_data, 
            subject=collected_info.get('subject', 'æœªçŸ¥'),
            grade=collected_info.get('grade', 'æœªçŸ¥')
        )
        
        if storyboard_raw:
            storyboard = clean_and_parse_json(storyboard_raw)
            if storyboard:
                storyboard_with_meta = {
                    "stage_index": i + 1,
                    "stage_name": stage_data.get("å…³å¡åç§°", f"å…³å¡{i+1}"),
                    "stage_id": stage_data.get("å…³å¡ç¼–å·", f"node_{i+1}"),
                    "storyboard": storyboard
                }
                all_storyboards.append(storyboard_with_meta)
                print(f"âœ… ç¬¬ {i+1} ä¸ªå…³å¡åˆ†é•œç”ŸæˆæˆåŠŸ")
            else:
                print(f"âŒ ç¬¬ {i+1} ä¸ªå…³å¡JSONè§£æå¤±è´¥")
        else:
            print(f"âŒ ç¬¬ {i+1} ä¸ªå…³å¡åˆ†é•œç”Ÿæˆå¤±è´¥")
    
    # ä¿å­˜åˆ°JSONæ–‡ä»¶
    if all_storyboards:
        output_data = {
            "story_id": story_data.get("story_id", "unknown"),
            "story_title": rpg_framework.get('æ ‡é¢˜', 'æœªçŸ¥æ•…äº‹'),
            "generated_time": datetime.now().isoformat(),
            "subject": collected_info.get('subject', 'æœªçŸ¥'),
            "grade": collected_info.get('grade', 'æœªçŸ¥'),
            "total_stages": len(stages_data),
            "successful_stages": len(all_storyboards),
            "storyboards": all_storyboards
        }
        
        filename = f"storyboards_{output_data['story_id']}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(output_data, f, ensure_ascii=False, indent=2)
        
        print(f"\nâœ… æ‰€æœ‰åˆ†é•œå·²ä¿å­˜åˆ°: {filename}")
        print(f"ğŸ“Š æˆåŠŸç”Ÿæˆ: {len(all_storyboards)}/{len(stages_data)} ä¸ªå…³å¡åˆ†é•œ")
        
        return filename
    else:
        print("âŒ æ²¡æœ‰æˆåŠŸç”Ÿæˆä»»ä½•åˆ†é•œ")
        return None


def test_storyboard_generator():
    """æµ‹è¯•åˆ†é•œç”Ÿæˆå™¨"""
    # ç¤ºä¾‹æ•°æ®
    rpg_framework = {
        "æ ‡é¢˜": "é­”æ³•ç‹å›½çš„æ•°å­¦å†’é™©",
        "ä¸–ç•Œè§‚": "åœ¨å……æ»¡é­”æ³•çš„ç‹å›½é‡Œï¼Œæ•°å­¦å…¬å¼æ˜¯æ–½å±•é­”æ³•çš„å…³é”®",
        "ä¸»çº¿å‰§æƒ…": "å°å‹‡å£«éœ€è¦å­¦ä¼šå„ç§æ•°å­¦é­”æ³•æ¥æ‹¯æ•‘è¢«è¯…å’’çš„ç‹å›½",
        "ä¸»è¦è§’è‰²": {
            "ç©å®¶è§’è‰²": "å……æ»¡å¥½å¥‡å¿ƒçš„å°å­¦ç”Ÿé­”æ³•å¸ˆ",
            "NPC": "æ™ºæ…§çš„è€é­”æ³•å¸ˆå¯¼å¸ˆï¼Œå–„è‰¯è€å¿ƒï¼Œå–œæ¬¢ç”¨ç”ŸåŠ¨çš„æ¯”å–»æ•™å­¦"
        }
    }
    
    stage_data = {
        "å…³å¡åç§°": "åŠ æ³•é­”æ³•é—¨",
        "åœºæ™¯åç§°": "é­”æ³•å›¾ä¹¦é¦†å…¥å£",
        "å…³å¡ç¼–å·": "node_1",
        "æ•™å­¦ç›®æ ‡": "æŒæ¡ä¸¤ä½æ•°åŠ æ³•è¿ç®—",
        "æ•…äº‹æƒ…å¢ƒ": "å°å‹‡å£«æ¥åˆ°é­”æ³•å›¾ä¹¦é¦†é—¨å‰ï¼Œå‘ç°é—¨ä¸Šæœ‰ä¸€é“åŠ æ³•è°œé¢˜éœ€è¦è§£ç­”æ‰èƒ½è¿›å…¥",
        "çŸ¥è¯†è®²è§£": "é€šè¿‡é­”æ³•é“å…·æ¼”ç¤ºåŠ æ³•çš„ç«–å¼è®¡ç®—æ–¹æ³•",
        "ä¸‹ä¸€å…³é€‰é¡¹": {
            "é€‰é¡¹1": {"æè¿°": "è¿›å…¥å·¦ä¾§çš„åŸºç¡€é­”æ³•åŒº", "ç›®æ ‡å…³å¡": "å…³å¡2"},
            "é€‰é¡¹2": {"æè¿°": "è¿›å…¥å³ä¾§çš„é«˜çº§é­”æ³•åŒº", "ç›®æ ‡å…³å¡": "å…³å¡3"}
        },
        "æ˜¯å¦ç»“æŸèŠ‚ç‚¹": False
    }
    
    # ç”Ÿæˆåˆ†é•œ
    storyboard_raw = generate_storyboard(rpg_framework, stage_data, "æ•°å­¦", "äºŒå¹´çº§")
    
    if storyboard_raw:
        print("\n" + "="*80)
        print("âœ… ç”Ÿæˆçš„åˆ†é•œè„šæœ¬:")
        print("="*80)
        
        # è§£æå¹¶æ ¼å¼åŒ–è¾“å‡º
        storyboard = clean_and_parse_json(storyboard_raw)
        if storyboard:
            print(json.dumps(storyboard, ensure_ascii=False, indent=2))
        else:
            print("JSONè§£æå¤±è´¥ï¼Œæ˜¾ç¤ºåŸå§‹è¾“å‡º:")
            print(storyboard_raw)
    else:
        print("âŒ åˆ†é•œç”Ÿæˆå¤±è´¥")


if __name__ == "__main__":
    # ä½¿ç”¨æ–°çš„æ‰¹é‡ç”ŸæˆåŠŸèƒ½
    generate_all_storyboards()