#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
åˆ†é•œç”Ÿæˆå™¨ï¼šåŸºäºRPGæ¡†æ¶å’Œå…³å¡æ•°æ®ç”Ÿæˆè¯¦ç»†åˆ†é•œè„šæœ¬
è¾“å…¥ï¼šRPGæ•…äº‹æ¡†æ¶ + å•ä¸ªå…³å¡æ•°æ®
è¾“å‡ºï¼šåˆ†é•œåŸºç¡€ä¿¡æ¯ã€äººç‰©å¯¹è¯ã€å‰§æœ¬ã€å›¾ç‰‡æç¤ºè¯
"""

import json
import os
from datetime import datetime
from upstash_redis import Redis
from dotenv import load_dotenv
from openai import OpenAI

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# åˆ†é•œç”Ÿæˆpromptæ¨¡æ¿
STORYBOARD_PROMPT = """ä½ æ˜¯ä¸€å"æ•™è‚²æ¸¸æˆåˆ†é•œè®¾è®¡å¸ˆ + ç¼–å‰§ + ç¾æœ¯æŒ‡å¯¼"ã€‚è¯·åŸºäºã€RPGæ¡†æ¶ã€‘å’Œã€å…³å¡æ•°æ®ã€‘ä¸ºè¿™ä¸ªå…³å¡ç”Ÿæˆå®Œæ•´çš„åˆ†é•œè„šæœ¬ï¼Œæœ€ç»ˆåªè¾“å‡ºä¸€ä¸ª JSON å¯¹è±¡ï¼Œ**ä¸è¦**è¾“å‡ºä»»ä½•è§£é‡Šæˆ–å¤šä½™æ–‡æœ¬ã€‚

ã€RPGæ¡†æ¶ã€‘
- æ ‡é¢˜ï¼š{title}
- ä¸–ç•Œè§‚ï¼š{worldview}
- ä¸»çº¿å‰§æƒ…ï¼š{main_plot}
- ç©å®¶è§’è‰²ï¼š{player_character}
- NPCè§’è‰²ï¼š{npc_character}

ã€å…³å¡æ•°æ®ã€‘
- å…³å¡åç§°ï¼š{stage_name}
- åœºæ™¯åç§°ï¼š{scene_name}
- å…³å¡ç¼–å·ï¼š{stage_id}
- æ•™å­¦ç›®æ ‡ï¼š{teaching_goal}
- æ•…äº‹æƒ…å¢ƒï¼š{story_context}
- çŸ¥è¯†è®²è§£ï¼š{knowledge_explanation}
- ä¸‹ä¸€å…³é€‰é¡¹ï¼š{next_options}
  è¯·åœ¨"åœºæ™¯è½¬æ¢"ä¸­ä½¿ç”¨æ ¼å¼ï¼šç›®æ ‡èŠ‚ç‚¹ID: é€‰é¡¹æè¿°
- æ˜¯å¦ç»“æŸèŠ‚ç‚¹ï¼š{is_final}

ã€å­¦ç§‘ä¿¡æ¯ã€‘
- å­¦ç§‘ï¼š{subject}
- å¹´çº§ï¼š{grade}

ã€è¾“å‡ºè¦æ±‚ã€‘

1) **åˆ†é•œåŸºç¡€ä¿¡æ¯**ï¼š
   - åˆ†é•œç¼–å·ï¼šæŒ‰"scene_[å…³å¡ç¼–å·]"æ ¼å¼
   - åœºæ™¯ç±»å‹ï¼šå¦‚"å¯¹è¯åœºæ™¯"ã€"å­¦ä¹ åœºæ™¯"ã€"é€‰æ‹©åœºæ™¯"ç­‰
   - æ—¶é•¿ä¼°è®¡ï¼šé¢„ä¼°è¯¥åˆ†é•œçš„æ¸¸æˆæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
   - å…³é”®äº‹ä»¶ï¼šæœ¬åˆ†é•œçš„æ ¸å¿ƒäº‹ä»¶æè¿°

2) **äººç‰©æ¡£æ¡ˆ**ï¼š
   - ä¸ºæœ¬å…³å¡æ¶‰åŠçš„è§’è‰²åˆ›å»ºè¯¦ç»†æ¡£æ¡ˆ
   - ä¸»è§’ä¿¡æ¯ï¼šè§’è‰²åã€å¤–è²Œã€æ€§æ ¼ã€ç‰¹æ®Šèƒ½åŠ›
   - NPCä¿¡æ¯ï¼šè§’è‰²åã€å¤–è²Œã€æ€§æ ¼ã€ä½œç”¨
   - è¦ä¸RPGæ¡†æ¶ä¸­çš„è§’è‰²è®¾å®šä¿æŒä¸€è‡´
   - å¤–è²Œå’Œæ€§æ ¼è¦é€‚åˆ{grade}å¹´çº§å­¦ç”Ÿç†è§£å’Œå–œçˆ±

3) **äººç‰©å¯¹è¯**ï¼š
   - æ ¹æ®æ•…äº‹æƒ…å¢ƒè®¾è®¡è‡ªç„¶çš„è§’è‰²å¯¹è¯
   - å¦‚æœæ˜¯å…³å¡å¼€å§‹ï¼šNPCä»‹ç»åœºæ™¯ã€å¼•å¯¼å­¦ä¹ 
   - å¦‚æœæ˜¯å­¦ä¹ ç¯èŠ‚ï¼šNPCè®²è§£çŸ¥è¯†ç‚¹ï¼Œç©å®¶å¯ä»¥æé—®
   - å¦‚æœæ˜¯å…³å¡ç»“å°¾ï¼šå¿…é¡»åŒ…å«é—®ç­”ç¯èŠ‚ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
     * NPC: é—®é¢˜å†…å®¹ï¼ˆæ ¹æ®æ•™å­¦ç›®æ ‡è®¾è®¡çš„é¢˜ç›®ï¼‰
     * ä¸»è§’é€‰é¡¹ï¼šA. é€‰é¡¹Aå†…å®¹  B. é€‰é¡¹Bå†…å®¹
     * åé¦ˆæœºåˆ¶ï¼šæ ¹æ®ä¸»è§’å›ç­”é—®é¢˜çš„å¯¹é”™åšå‡ºèµèµæˆ–è€…é¼“åŠ±ï¼Œå¹¶ä½œå‡ºç›¸åº”çš„è§£é‡Šæˆ–è€…æç¤º
   - å¦‚æœä¸æ˜¯ç»“æŸèŠ‚ç‚¹ï¼šé—®ç­”åæä¾›é€šå¾€ä¸‹ä¸ªåœºæ™¯çš„é€‰é¡¹ï¼Œæ ¼å¼ä¸º"ç›®æ ‡èŠ‚ç‚¹ID: é€‰é¡¹æè¿°"
   - ä¿æŒè§’è‰²æ€§æ ¼ä¸€è‡´ï¼Œè¯­è¨€ç¬¦åˆ{grade}å¹´çº§ç†è§£æ°´å¹³
   - é¢˜ç›®å†…å®¹å¿…é¡»ç¬¦åˆ{subject}å­¦ç§‘å’Œ{grade}å¹´çº§è®¤çŸ¥æ°´å¹³ï¼Œèƒ½å¤Ÿè‡ªç„¶èå…¥RPGæ•…äº‹èƒŒæ™¯

4) **å‰§æœ¬**ï¼š
   - æ—ç™½ï¼šæ•…äº‹æƒ…å¢ƒçš„èƒŒæ™¯ä»‹ç» - è¯¦ç»†æè¿°å½“å‰åœºæ™¯çš„ç¯å¢ƒã€æ°›å›´ã€ä»¥åŠç©å®¶è§’è‰²æ‰€å¤„çš„çŠ¶å†µã€‚è¦ç”ŸåŠ¨å…·ä½“ï¼Œè®©è¯»è€…èƒ½å¤Ÿæƒ³è±¡å‡ºå®Œæ•´çš„åœºæ™¯ç”»é¢ã€‚
   - æƒ…èŠ‚æè¿°ï¼šå°†æ•…äº‹æƒ…å¢ƒå†™å¾—æ›´åŠ å®Œæ•´è¯¦ç»† - ä¸ä»…åŒ…å«åŸºæœ¬çš„æ•…äº‹èƒŒæ™¯ï¼Œè¿˜è¦æè¿°è§’è‰²çš„å¿ƒç†çŠ¶æ€ã€ç¯å¢ƒçš„ç»†èŠ‚å˜åŒ–ã€ä»¥åŠæ¨åŠ¨å‰§æƒ…å‘å±•çš„å…³é”®äº‹ä»¶ã€‚è¦æœ‰èµ·æ‰¿è½¬åˆçš„å®Œæ•´ç»“æ„ã€‚
   - äº’åŠ¨è®¾è®¡ï¼šç»“åˆæ•…äº‹æƒ…æ™¯å’ŒRPGæ¡†æ¶ï¼Œæ ¹æ®ç”¨æˆ·çš„äº’åŠ¨éœ€æ±‚æ¥è®¾è®¡å…·ä½“çš„äº’åŠ¨ç¯èŠ‚ - ç‰¹åˆ«æ˜¯ä¸ºäº†è§£å¼€é¢˜ç›®è€Œè®¾è®¡çš„æƒ…æ™¯äº’åŠ¨ã€‚åŒ…æ‹¬ï¼šç©å®¶å¦‚ä½•å‘ç°é¢˜ç›®ã€ä¸NPCçš„äº’åŠ¨è¿‡ç¨‹ã€è§£é¢˜çš„å…·ä½“æ­¥éª¤ã€ä»¥åŠæˆåŠŸ/å¤±è´¥åçš„åé¦ˆæœºåˆ¶ã€‚è¦è®©å­¦ä¹ è¿‡ç¨‹è‡ªç„¶èå…¥æ¸¸æˆæƒ…å¢ƒä¸­ã€‚

5) **å›¾ç‰‡æç¤ºè¯**ï¼š
   - è§†è§‰é£æ ¼ï¼šä¸åœºæ™¯åç§°ã€RPGæ¡†æ¶ä»¥åŠæ•™è‚²ç›®æ ‡é…å¥—çš„è§†è§‰é£æ ¼
   - åœºæ™¯æè¿°ï¼šä¸åœºæ™¯åç§°ã€RPGæ¡†æ¶ä»¥åŠæ•™è‚²ç›®æ ‡é…å¥—çš„æ•…äº‹æƒ…æ™¯ç”Ÿæˆçš„åœºæ™¯
   - è§’è‰²æè¿°ï¼šNPCå’Œç©å®¶ä¸¤ä¸ªè§’è‰²çš„è¯¦ç»†ä»‹ç»ï¼ˆåˆå¹¶ä¸ºä¸€å¥è¯æè¿°ï¼‰
   - æ„å›¾è¦æ±‚ï¼šæ ¹æ®å…³å¡æ‰€å¤„çš„æ•…äº‹é˜¶æ®µèµ·åˆ°çš„ä½œç”¨æ€§ä»¥åŠç¬¦åˆåœºæ™¯å†…å®¹ã€RPGæ¡†æ¶çš„è§†è§‰å…ƒç´ 
   - æŠ€æœ¯å‚æ•°ï¼šé«˜åˆ†è¾¨ç‡ï¼Œé€‚åˆç§»åŠ¨ç«¯å‘ˆç°

ã€ç‰¹æ®Šè¦æ±‚ã€‘

1) **é¢˜ç›®è®¾è®¡åŸåˆ™**ï¼š
   - é¢˜ç›®å†…å®¹å¿…é¡»ç¬¦åˆ{subject}å­¦ç§‘å’Œ{grade}å¹´çº§è®¤çŸ¥æ°´å¹³
   - é¢˜ç›®èƒ½å¤Ÿè‡ªç„¶èå…¥RPGæ•…äº‹èƒŒæ™¯å’Œå½“å‰åœºæ™¯
   - é€‰é¡¹è®¾ç½®è¦æœ‰ä¸€å®šè¿·æƒ‘æ€§ä½†ä¸è¿‡åˆ†å›°éš¾
   - è§£é‡Šè¦é€šä¿—æ˜“æ‡‚ï¼Œç»“åˆæ•…äº‹å…ƒç´ 

2) **å¯¹è¯é£æ ¼**ï¼š
   - NPCè¯´è¯è¦ç¬¦åˆå…¶åœ¨RPGæ¡†æ¶ä¸­çš„äººè®¾
   - è¯­è¨€æ´»æ³¼ç”ŸåŠ¨ï¼Œé€‚åˆ{grade}å¹´çº§å­¦ç”Ÿ
   - é¼“åŠ±æ€§è¯­è¨€è¦çœŸè¯šä¸åšä½œ
   - è¡¨æ‰¬è¦å…·ä½“æŒ‡å‡ºå­¦ç”Ÿåšå¾—å¥½çš„åœ°æ–¹

3) **åœºæ™¯è¿è´¯æ€§**ï¼š
   - ä¸ä¸Šä¸€å…³å¡çš„æ•…äº‹è‡ªç„¶è¡”æ¥
   - ä¸ºä¸‹ä¸€å…³å¡åšå¥½é“ºå«
   - ä¿æŒæ•´ä½“ä¸–ç•Œè§‚çš„ä¸€è‡´æ€§

ã€è¾“å‡ºæ ¼å¼ã€‘ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONç»“æ„ï¼š

{{
  "åˆ†é•œåŸºç¡€ä¿¡æ¯": {{
    "åˆ†é•œç¼–å·": "scene_{stage_id}",
    "åœºæ™¯ç±»å‹": "...",
    "æ—¶é•¿ä¼°è®¡": "...åˆ†é’Ÿ",
    "å…³é”®äº‹ä»¶": "..."
  }},
  "äººç‰©æ¡£æ¡ˆ": {{
    "ä¸»è§’": {{
      "è§’è‰²å": "...",
      "å¤–è²Œ": "...",
      "æ€§æ ¼": "...",
      "ç‰¹æ®Šèƒ½åŠ›": "..."
    }},
    "NPC": {{
      "è§’è‰²å": "...",
      "å¤–è²Œ": "...",
      "æ€§æ ¼": "...",
      "ä½œç”¨": "..."
    }}
  }},
  "äººç‰©å¯¹è¯": {{
    "å¼€åœºå¯¹è¯": [
      {{
        "è§’è‰²": "NPC",
        "å†…å®¹": "..."
      }},
      {{
        "è§’è‰²": "ç©å®¶",
        "å†…å®¹": "..."
      }}
    ],
    "å­¦ä¹ å¯¹è¯": [
      {{
        "è§’è‰²": "NPC", 
        "å†…å®¹": "..."
      }}
    ],
    "é—®ç­”ç¯èŠ‚": {{
      "NPC": "é—®é¢˜å†…å®¹ï¼ˆæ ¹æ®æ•™å­¦ç›®æ ‡è®¾è®¡çš„å…·ä½“é¢˜ç›®ï¼‰",
      "ä¸»è§’é€‰é¡¹": {{
        "A": "é€‰é¡¹Aå†…å®¹",
        "B": "é€‰é¡¹Bå†…å®¹",
        "æ­£ç¡®ç­”æ¡ˆ": "Aæˆ–B"
      }},
      "åé¦ˆæœºåˆ¶": {{
        "æ­£ç¡®åé¦ˆ": "è¡¨æ‰¬å’Œè§£é‡Šä¸ºä»€ä¹ˆæ­£ç¡®...",
        "é”™è¯¯åé¦ˆ": "é¼“åŠ±æ€§è§£é‡Šå’Œæç¤º..."
      }}
    }},
    "åœºæ™¯è½¬æ¢": {{
      "node_id_1": "é€‰é¡¹1æè¿°...",
      "node_id_2": "é€‰é¡¹2æè¿°..."
    }}
  }},
  "å‰§æœ¬": {{
    "æ—ç™½": "æ•…äº‹æƒ…å¢ƒçš„èƒŒæ™¯ä»‹ç»ï¼Œè¯¦ç»†æè¿°å½“å‰åœºæ™¯çš„ç¯å¢ƒã€æ°›å›´ã€ä»¥åŠç©å®¶è§’è‰²æ‰€å¤„çš„çŠ¶å†µã€‚è¦ç”ŸåŠ¨å…·ä½“ï¼Œè®©è¯»è€…èƒ½å¤Ÿæƒ³è±¡å‡ºå®Œæ•´çš„åœºæ™¯ç”»é¢ã€‚",
    "æƒ…èŠ‚æè¿°": "å°†æ•…äº‹æƒ…å¢ƒå†™å¾—æ›´åŠ å®Œæ•´è¯¦ç»†ï¼Œä¸ä»…åŒ…å«åŸºæœ¬çš„æ•…äº‹èƒŒæ™¯ï¼Œè¿˜è¦æè¿°è§’è‰²çš„å¿ƒç†çŠ¶æ€ã€ç¯å¢ƒçš„ç»†èŠ‚å˜åŒ–ã€ä»¥åŠæ¨åŠ¨å‰§æƒ…å‘å±•çš„å…³é”®äº‹ä»¶ã€‚è¦æœ‰èµ·æ‰¿è½¬åˆçš„å®Œæ•´ç»“æ„ã€‚",
    "äº’åŠ¨è®¾è®¡": "ç»“åˆæ•…äº‹æƒ…æ™¯å’ŒRPGæ¡†æ¶ï¼Œæ ¹æ®ç”¨æˆ·çš„äº’åŠ¨éœ€æ±‚æ¥è®¾è®¡å…·ä½“çš„äº’åŠ¨ç¯èŠ‚ï¼Œç‰¹åˆ«æ˜¯ä¸ºäº†è§£å¼€é¢˜ç›®è€Œè®¾è®¡çš„æƒ…æ™¯äº’åŠ¨ã€‚åŒ…æ‹¬ï¼šç©å®¶å¦‚ä½•å‘ç°é¢˜ç›®ã€ä¸NPCçš„äº’åŠ¨è¿‡ç¨‹ã€è§£é¢˜çš„å…·ä½“æ­¥éª¤ã€ä»¥åŠæˆåŠŸ/å¤±è´¥åçš„åé¦ˆæœºåˆ¶ã€‚è¦è®©å­¦ä¹ è¿‡ç¨‹è‡ªç„¶èå…¥æ¸¸æˆæƒ…å¢ƒä¸­ã€‚"
  }},
  "å›¾ç‰‡æç¤ºè¯": {{
    "è§†è§‰é£æ ¼": "ä¸åœºæ™¯åç§°ã€RPGæ¡†æ¶ä»¥åŠæ•™è‚²ç›®æ ‡é…å¥—çš„è§†è§‰é£æ ¼æè¿°...",
    "åœºæ™¯æè¿°": "ä¸åœºæ™¯åç§°ã€RPGæ¡†æ¶ä»¥åŠæ•™è‚²ç›®æ ‡é…å¥—çš„æ•…äº‹æƒ…æ™¯ç”Ÿæˆçš„åœºæ™¯æè¿°...",
    "è§’è‰²æè¿°": "NPCè§’è‰²å’Œç©å®¶è§’è‰²çš„è¯¦ç»†å¤–è§‚å’Œç‰¹å¾æè¿°...",
    "æ„å›¾è¦æ±‚": "æ ¹æ®å…³å¡æ‰€å¤„çš„æ•…äº‹é˜¶æ®µèµ·åˆ°çš„ä½œç”¨æ€§ä»¥åŠç¬¦åˆåœºæ™¯å†…å®¹ã€RPGæ¡†æ¶çš„è§†è§‰å…ƒç´ æ„å›¾è¦æ±‚...",
    "æŠ€æœ¯å‚æ•°": "é«˜åˆ†è¾¨ç‡ï¼Œé€‚åˆç§»åŠ¨ç«¯å‘ˆç°ï¼Œä»¥åŠå…¶ä»–æŠ€æœ¯è¦æ±‚..."
  }}
}}

ã€æ ¼å¼è¦æ±‚ã€‘
- æ‰€æœ‰å­—æ®µå¿…é¡»å¡«å†™ï¼Œä¸èƒ½ä¸ºç©ºæˆ–"..."
- å¯¹è¯å†…å®¹è¦å…·ä½“ç”ŸåŠ¨ï¼Œä¸èƒ½è¿‡äºç®€å•
- é¢˜ç›®è¦ç»“åˆå…·ä½“çš„çŸ¥è¯†ç‚¹å’Œåœºæ™¯èƒŒæ™¯
- å‰§æœ¬çš„ä¸‰ä¸ªéƒ¨åˆ†è¦è¯¦ç»†å®Œæ•´ï¼Œæä¾›è¶³å¤Ÿçš„å®æ–½æŒ‡å¯¼
- **åœºæ™¯è½¬æ¢æ ¼å¼è¦æ±‚**ï¼šå¿…é¡»ä½¿ç”¨"ç›®æ ‡èŠ‚ç‚¹ID: é€‰é¡¹æè¿°"çš„æ ¼å¼ï¼Œæ ¹æ®å…³å¡æ•°æ®ä¸­çš„"ä¸‹ä¸€å…³é€‰é¡¹"æ¥ç”Ÿæˆ
- å¦‚æœæ˜¯ç»“æŸèŠ‚ç‚¹ï¼Œ"åœºæ™¯è½¬æ¢"å­—æ®µå¯ä»¥çœç•¥
- JSONæ ¼å¼å¿…é¡»æ­£ç¡®ï¼Œç¡®ä¿å¯ä»¥è¢«è§£æ

è¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°è¦æ±‚ç”Ÿæˆåˆ†é•œè„šæœ¬ã€‚"""


def generate_storyboard(rpg_framework, stage_data, subject="", grade=""):
    """ç”Ÿæˆå•ä¸ªå…³å¡çš„åˆ†é•œè„šæœ¬"""
    try:
        # æ ¼å¼åŒ–prompt
        formatted_prompt = STORYBOARD_PROMPT.format(
            title=rpg_framework.get('æ ‡é¢˜', ''),
            worldview=rpg_framework.get('ä¸–ç•Œè§‚', ''),
            main_plot=rpg_framework.get('ä¸»çº¿å‰§æƒ…', ''),
            player_character=rpg_framework.get('ä¸»è¦è§’è‰²', {}).get('ç©å®¶è§’è‰²', ''),
            npc_character=rpg_framework.get('ä¸»è¦è§’è‰²', {}).get('NPC', ''),
            
            stage_name=stage_data.get('å…³å¡åç§°', ''),
            scene_name=stage_data.get('åœºæ™¯åç§°', ''),
            stage_id=stage_data.get('å…³å¡ç¼–å·', ''),
            teaching_goal=stage_data.get('æ•™å­¦ç›®æ ‡', ''),
            story_context=stage_data.get('æ•…äº‹æƒ…å¢ƒ', ''),
            knowledge_explanation=stage_data.get('çŸ¥è¯†è®²è§£', ''),
            next_options=json.dumps(stage_data.get('ä¸‹ä¸€å…³é€‰é¡¹', {}), ensure_ascii=False),
            is_final=stage_data.get('æ˜¯å¦ç»“æŸèŠ‚ç‚¹', False),
            
            subject=subject,
            grade=grade
        )
        
        print(f"ğŸ¬ æ­£åœ¨ç”Ÿæˆå…³å¡ {stage_data.get('å…³å¡åç§°', '')} çš„åˆ†é•œè„šæœ¬...")
        
        # è°ƒç”¨OpenAI API
        client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
        response = client.chat.completions.create(
            model="gpt-4-turbo-preview",
            messages=[
                {
                    "role": "system",
                    "content": "ä½ æ˜¯ä¸“ä¸šçš„æ•™è‚²æ¸¸æˆåˆ†é•œè®¾è®¡å¸ˆï¼Œæ“…é•¿åˆ›ä½œç”ŸåŠ¨æœ‰è¶£çš„æ•™å­¦æ¸¸æˆå‰§æœ¬ã€‚"
                },
                {
                    "role": "user",
                    "content": formatted_prompt
                }
            ],
            temperature=0.8,
            max_tokens=3000
        )
        
        return response.choices[0].message.content
        
    except Exception as e:
        print(f"âŒ åˆ†é•œç”Ÿæˆå¤±è´¥: {e}")
        return None


def clean_and_parse_json(raw_output):
    """æ¸…ç†å¹¶è§£æAIè¾“å‡ºçš„JSON"""
    try:
        # æ¸…ç†markdownä»£ç å—æ ‡è®°
        cleaned = raw_output.strip()
        if cleaned.startswith("```json"):
            cleaned = cleaned[7:]
        if cleaned.startswith("```"):
            cleaned = cleaned[3:]
        if cleaned.endswith("```"):
            cleaned = cleaned[:-3]
        
        cleaned = cleaned.strip()
        return json.loads(cleaned)
        
    except json.JSONDecodeError as e:
        print(f"âŒ JSONè§£æå¤±è´¥: {e}")
        print(f"åŸå§‹è¾“å‡ºå‰200å­—ç¬¦: {raw_output[:200]}...")
        return None


def connect_redis():
    """è¿æ¥Redis"""
    try:
        redis = Redis(
            url=os.getenv("UPSTASH_REDIS_URL"),
            token=os.getenv("UPSTASH_REDIS_TOKEN")
        )
        return redis
    except Exception as e:
        print(f"âŒ Redisè¿æ¥å¤±è´¥: {e}")
        return None


def get_story_data(redis_client, story_id=None):
    """ä»Redisè·å–æ•…äº‹æ•°æ®"""
    try:
        if not story_id:
            # è·å–æœ€æ–°çš„æ•…äº‹
            index_key = "eduagent:story_index"
            story_list_data = redis_client.get(index_key)
            if story_list_data:
                story_list = json.loads(story_list_data)
                if story_list:
                    story_id = story_list[-1]["story_id"]
                    print(f"ğŸ“– ä½¿ç”¨æœ€æ–°æ•…äº‹: {story_id}")
                else:
                    print("âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ•…äº‹æ•°æ®")
                    return None
            else:
                print("âŒ æ•…äº‹ç´¢å¼•ä¸å­˜åœ¨")
                return None
        
        # è·å–æ•…äº‹å®Œæ•´æ•°æ®
        main_key = f"eduagent:stories:{story_id}"
        story_data = redis_client.get(main_key)
        if story_data:
            return json.loads(story_data)
        else:
            print(f"âŒ æœªæ‰¾åˆ°æ•…äº‹æ•°æ®: {story_id}")
            return None
            
    except Exception as e:
        print(f"âŒ è·å–æ•…äº‹æ•°æ®å¤±è´¥: {e}")
        return None


def get_stage1_data(redis_client, requirement_id=None):
    """è·å–ç¬¬ä¸€é˜¶æ®µæ•°æ®ï¼ˆåŒ…å«collected_infoå­—æ®µï¼‰"""
    try:
        if requirement_id:
            key = f"eduagent:requirements:{requirement_id}"
        else:
            # è·å–æœ€æ–°çš„
            keys = redis_client.keys("eduagent:requirements:requirement_*")
            if not keys:
                print("âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç¬¬ä¸€é˜¶æ®µæ•°æ®")
                return None
            key = keys[0]
        
        data = redis_client.get(key)
        if not data:
            print(f"âŒ æœªæ‰¾åˆ°ç¬¬ä¸€é˜¶æ®µæ•°æ®")
            return None
        
        return json.loads(data)
    except Exception as e:
        print(f"âŒ è·å–ç¬¬ä¸€é˜¶æ®µæ•°æ®å¤±è´¥: {e}")
        return None


def generate_all_storyboards(story_id=None):
    """ä¸ºæŒ‡å®šæ•…äº‹ç”Ÿæˆæ‰€æœ‰å…³å¡çš„åˆ†é•œ"""
    # è¿æ¥Redis
    redis_client = connect_redis()
    if not redis_client:
        return
    
    # è·å–æ•…äº‹æ•°æ®
    story_data = get_story_data(redis_client, story_id)
    if not story_data:
        return
    
    # è·å–ç¬¬ä¸€é˜¶æ®µæ•°æ®ï¼ˆåŒ…å«collected_infoï¼‰
    stage1_data = get_stage1_data(redis_client)
    if not stage1_data:
        print("âš ï¸ æœªæ‰¾åˆ°ç¬¬ä¸€é˜¶æ®µæ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼")
        collected_info = {}
    else:
        collected_info = stage1_data.get('collected_info', {})
    
    rpg_framework = story_data.get("rpg_framework", {})
    stages_data = story_data.get("stages_data", [])
    
    print(f"ğŸ® æ•…äº‹æ ‡é¢˜: {rpg_framework.get('æ ‡é¢˜', 'æœªçŸ¥')}")
    print(f"ğŸ“š æ€»å…³å¡æ•°: {len(stages_data)}")
    print(f"ğŸ“ å­¦ç§‘å¹´çº§: {collected_info.get('subject', 'æœªçŸ¥')} - {collected_info.get('grade', 'æœªçŸ¥')}")
    
    # ç”Ÿæˆæ‰€æœ‰åˆ†é•œ
    all_storyboards = []
    for i, stage_data in enumerate(stages_data):
        print(f"\nğŸ¬ ç”Ÿæˆç¬¬ {i+1}/{len(stages_data)} ä¸ªå…³å¡çš„åˆ†é•œ...")
        print(f"å…³å¡åç§°: {stage_data.get('å…³å¡åç§°', f'å…³å¡{i+1}')}")
        
        # ç”Ÿæˆåˆ†é•œï¼Œä½¿ç”¨collected_infoä¸­çš„å­—æ®µ
        storyboard_raw = generate_storyboard(
            rpg_framework, 
            stage_data, 
            subject=collected_info.get('subject', 'æœªçŸ¥'),
            grade=collected_info.get('grade', 'æœªçŸ¥')
        )
        
        if storyboard_raw:
            storyboard = clean_and_parse_json(storyboard_raw)
            if storyboard:
                storyboard_with_meta = {
                    "stage_index": i + 1,
                    "stage_name": stage_data.get("å…³å¡åç§°", f"å…³å¡{i+1}"),
                    "stage_id": stage_data.get("å…³å¡ç¼–å·", f"node_{i+1}"),
                    "storyboard": storyboard
                }
                all_storyboards.append(storyboard_with_meta)
                print(f"âœ… ç¬¬ {i+1} ä¸ªå…³å¡åˆ†é•œç”ŸæˆæˆåŠŸ")
            else:
                print(f"âŒ ç¬¬ {i+1} ä¸ªå…³å¡JSONè§£æå¤±è´¥")
        else:
            print(f"âŒ ç¬¬ {i+1} ä¸ªå…³å¡åˆ†é•œç”Ÿæˆå¤±è´¥")
    
    # ä¿å­˜åˆ°JSONæ–‡ä»¶
    if all_storyboards:
        output_data = {
            "story_id": story_data.get("story_id", "unknown"),
            "story_title": rpg_framework.get('æ ‡é¢˜', 'æœªçŸ¥æ•…äº‹'),
            "generated_time": datetime.now().isoformat(),
            "subject": collected_info.get('subject', 'æœªçŸ¥'),
            "grade": collected_info.get('grade', 'æœªçŸ¥'),
            "total_stages": len(stages_data),
            "successful_stages": len(all_storyboards),
            "storyboards": all_storyboards
        }
        
        filename = f"storyboards_{output_data['story_id']}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(output_data, f, ensure_ascii=False, indent=2)
        
        print(f"\nâœ… æ‰€æœ‰åˆ†é•œå·²ä¿å­˜åˆ°: {filename}")
        print(f"ğŸ“Š æˆåŠŸç”Ÿæˆ: {len(all_storyboards)}/{len(stages_data)} ä¸ªå…³å¡åˆ†é•œ")
        
        return filename
    else:
        print("âŒ æ²¡æœ‰æˆåŠŸç”Ÿæˆä»»ä½•åˆ†é•œ")
        return None


def test_storyboard_generator():
    """æµ‹è¯•åˆ†é•œç”Ÿæˆå™¨"""
    # ç¤ºä¾‹æ•°æ®
    rpg_framework = {
        "æ ‡é¢˜": "é­”æ³•ç‹å›½çš„æ•°å­¦å†’é™©",
        "ä¸–ç•Œè§‚": "åœ¨å……æ»¡é­”æ³•çš„ç‹å›½é‡Œï¼Œæ•°å­¦å…¬å¼æ˜¯æ–½å±•é­”æ³•çš„å…³é”®",
        "ä¸»çº¿å‰§æƒ…": "å°å‹‡å£«éœ€è¦å­¦ä¼šå„ç§æ•°å­¦é­”æ³•æ¥æ‹¯æ•‘è¢«è¯…å’’çš„ç‹å›½",
        "ä¸»è¦è§’è‰²": {
            "ç©å®¶è§’è‰²": "å……æ»¡å¥½å¥‡å¿ƒçš„å°å­¦ç”Ÿé­”æ³•å¸ˆ",
            "NPC": "æ™ºæ…§çš„è€é­”æ³•å¸ˆå¯¼å¸ˆï¼Œå–„è‰¯è€å¿ƒï¼Œå–œæ¬¢ç”¨ç”ŸåŠ¨çš„æ¯”å–»æ•™å­¦"
        }
    }
    
    stage_data = {
        "å…³å¡åç§°": "åŠ æ³•é­”æ³•é—¨",
        "åœºæ™¯åç§°": "é­”æ³•å›¾ä¹¦é¦†å…¥å£",
        "å…³å¡ç¼–å·": "node_1",
        "æ•™å­¦ç›®æ ‡": "æŒæ¡ä¸¤ä½æ•°åŠ æ³•è¿ç®—",
        "æ•…äº‹æƒ…å¢ƒ": "å°å‹‡å£«æ¥åˆ°é­”æ³•å›¾ä¹¦é¦†é—¨å‰ï¼Œå‘ç°é—¨ä¸Šæœ‰ä¸€é“åŠ æ³•è°œé¢˜éœ€è¦è§£ç­”æ‰èƒ½è¿›å…¥",
        "çŸ¥è¯†è®²è§£": "é€šè¿‡é­”æ³•é“å…·æ¼”ç¤ºåŠ æ³•çš„ç«–å¼è®¡ç®—æ–¹æ³•",
        "ä¸‹ä¸€å…³é€‰é¡¹": {
            "é€‰é¡¹1": {"æè¿°": "è¿›å…¥å·¦ä¾§çš„åŸºç¡€é­”æ³•åŒº", "ç›®æ ‡å…³å¡": "å…³å¡2"},
            "é€‰é¡¹2": {"æè¿°": "è¿›å…¥å³ä¾§çš„é«˜çº§é­”æ³•åŒº", "ç›®æ ‡å…³å¡": "å…³å¡3"}
        },
        "æ˜¯å¦ç»“æŸèŠ‚ç‚¹": False
    }
    
    # ç”Ÿæˆåˆ†é•œ
    storyboard_raw = generate_storyboard(rpg_framework, stage_data, "æ•°å­¦", "äºŒå¹´çº§")
    
    if storyboard_raw:
        print("\n" + "="*80)
        print("âœ… ç”Ÿæˆçš„åˆ†é•œè„šæœ¬:")
        print("="*80)
        
        # è§£æå¹¶æ ¼å¼åŒ–è¾“å‡º
        storyboard = clean_and_parse_json(storyboard_raw)
        if storyboard:
            print(json.dumps(storyboard, ensure_ascii=False, indent=2))
        else:
            print("JSONè§£æå¤±è´¥ï¼Œæ˜¾ç¤ºåŸå§‹è¾“å‡º:")
            print(storyboard_raw)
    else:
        print("âŒ åˆ†é•œç”Ÿæˆå¤±è´¥")


if __name__ == "__main__":
    # ä½¿ç”¨æ–°çš„æ‰¹é‡ç”ŸæˆåŠŸèƒ½
    generate_all_storyboards()